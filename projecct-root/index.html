<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Booking System</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for professional touch -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* General Font and Background */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #4d4be4; 

            background-size: cover; 
            background-attachment: fixed;
            background-position: center;
        }
        /* Custom Scrollbar for look */
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: #0f0f0f; }

        /* Icon Styling */
        .icon { display: inline-block; vertical-align: middle; }

        /* Styling for the selector options (for visual separation) */
        optgroup { font-weight: bold; padding: 5px 0; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center py-8 px-4">

        <!-- Header -->
        <header class="w-full max-w-5xl text-center mb-8 p-6 bg-white rounded-2xl shadow-xl border-t-4 border-indigo-600">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center justify-center">
                <i data-lucide="calendar-check" class="icon text-indigo-600 mr-3 h-8 w-8"></i>
                Classroom Booking System
            </h1>
            <p id="user-status" class="text-md mt-2 text-gray-500">
                Logged in as: <span id="current-role" class="font-semibold text-red-500">Instructor (ID 1)</span>
            </p>
        </header>

        <!-- Role Selector and Switcher -->
        <div class="w-full max-w-5xl mb-8 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 p-4 bg-white rounded-xl shadow-md">
            
            <div class="flex items-center space-x-2 p-2 border border-gray-200 rounded-lg bg-gray-50">
                <i data-lucide="user" class="icon h-5 w-5 text-gray-600"></i>
                <label for="user-id-select" class="text-sm font-medium text-gray-700">Change User:</label>
                <select id="user-id-select" onchange="updateUserId(this.value)" class="p-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 transition">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="flex space-x-4">
                <button onclick="switchRole('instructor')" id="btn-instructor"
                    class="flex items-center px-6 py-3 font-semibold rounded-xl shadow-lg transition duration-200 text-white bg-indigo-600 hover:bg-indigo-700">
                    <i data-lucide="graduation-cap" class="icon mr-2 h-5 w-5"></i> Instructor View
                </button>
                <button onclick="switchRole('admin')" id="btn-admin"
                    class="flex items-center px-6 py-3 font-semibold rounded-xl shadow-lg transition duration-200 text-white bg-amber-600 hover:bg-amber-700">
                    <i data-lucide="shield" class="icon mr-2 h-5 w-5"></i> Administrator Panel
                </button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="content-area" class="w-full max-w-5xl p-8 bg-white rounded-2xl shadow-2xl border"></main>

        <!-- Message/Modal Area -->
        <div id="message-area" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50" onclick="hideMessage()">
            <div id="message-content" class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-100" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-xl font-extrabold mb-3 text-indigo-700 flex items-center"></h3>
                <p id="message-text" class="text-gray-700 leading-relaxed"></p>
                <div class="mt-6 flex justify-end">
                    <button onclick="hideMessage()" class="px-6 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow-md transition duration-150">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. Global State and Utilities ---
        let currentRole = 'instructor';
        let currentUserId = 1;

        // Mock Database Data (Data structure mirrors the SQL schema for functionality)
        // THIS SECTION HAS BEEN UPDATED TO INCLUDE 5 INSTRUCTORS AND 5 ADMINISTRATORS
        let DB = {
            instructors: [
                { InstructorID: 1, Name: 'Dr. Evelyn Reed', Department: 'Computer Science' },
                { InstructorID: 2, Name: 'Prof. Samuel Chen', Department: 'Physics' },
                { InstructorID: 3, Name: 'Dr. Maria Garcia', Department: 'History' },
                { InstructorID: 4, Name: 'Dr. Alex Jones', Department: 'Mathematics' },
                { InstructorID: 5, Name: 'Prof. Lena Khan', Department: 'Biology' }
            ],
            administrators: [
                { AdminID: 1, Name: 'Admin Alice' },
                { AdminID: 2, Name: 'Admin Bob' },
                { AdminID: 3, Name: 'Admin Carol' },
                { AdminID: 4, Name: 'Admin David' },
                { AdminID: 5, Name: 'Admin Eva' }
            ],
            rooms: [
                { RoomID: 1, RoomNameOrNumber: 'Room 101', Capacity: 50, Location: 'Main Hall', Features: ['Projector', 'Whiteboard'] },
                { RoomID: 2, RoomNameOrNumber: 'Room 102', Capacity: 30, Location: 'Main Hall', Features: ['Projector', 'Zoom-Capable'] },
                { RoomID: 3, RoomNameOrNumber: 'Room 205 (Lab)', Capacity: 40, Location: 'Science Wing', Features: ['Projector', 'Lab Equipment'] },
                { RoomID: 4, RoomNameOrNumber: 'Auditorium B', Capacity: 150, Location: 'West Wing', Features: ['Projector', 'Smartboard'] },
                { RoomID: 5, RoomNameOrNumber: 'Room 310', Capacity: 20, Location: 'Third Floor', Features: ['Projector', 'Sound System'] }
            ],
            courses: [
                { CourseID: 1, CourseName: 'CS101', Requirements: ['Projector', 'Whiteboard'] },
                { CourseID: 2, CourseName: 'PHYS200', Requirements: ['Projector', 'Lab Equipment'] },
                { CourseID: 3, CourseName: 'HIST150', Requirements: ['Projector'] },
                { CourseID: 4, CourseName: 'MATH301', Requirements: ['Projector'] },
                { CourseID: 5, CourseName: 'BIO105', Requirements: ['Lab Equipment'] }
            ],
            bookings: [
                // Booking 1: Approved (Instructor 1)
                { BookingID: 1, Date: '2025-12-10', StartTime: '09:00', EndTime: '10:30', Status: 'Approved', RoomID: 1, InstructorID: 1, CourseID: 1, AdminID: 1 },
                // Booking 2: Pending (Instructor 2)
                { BookingID: 2, Date: '2025-12-10', StartTime: '11:00', EndTime: '12:30', Status: 'Pending', RoomID: 3, InstructorID: 2, CourseID: 2, AdminID: null },
                // Booking 3: Pending (Instructor 3)
                { BookingID: 3, Date: '2025-12-10', StartTime: '14:00', EndTime: '15:00', Status: 'Approved', RoomID: 2, InstructorID: 3, CourseID: 3, AdminID: 2 },
                // Booking 4: Pending (Instructor 4)
                { BookingID: 4, Date: '2025-12-11', StartTime: '10:00', EndTime: '11:30', Status: 'Pending', RoomID: 4, InstructorID: 4, CourseID: 4, AdminID: null },
                // Booking 5: Rejected (Instructor 5)
                { BookingID: 5, Date: '2025-12-11', StartTime: '14:00', EndTime: '15:00', Status: 'Rejected', RoomID: 5, InstructorID: 5, CourseID: 5, AdminID: 3 }
            ]
        };

        function showMessage(title, text, iconHtml = '<i data-lucide="bell" class="icon mr-2 text-indigo-600 h-5 w-5"></i>') {
            document.getElementById('message-title').innerHTML = iconHtml + title;
            document.getElementById('message-text').innerHTML = text;
            document.getElementById('message-area').classList.remove('hidden');
            document.getElementById('message-area').classList.add('flex');
            lucide.createIcons();
        }

        function hideMessage() {
            document.getElementById('message-area').classList.add('hidden');
            document.getElementById('message-area').classList.remove('flex');
        }

        // --- 2. Role Switching and Initialization ---
        
        function populateUserIdSelector() {
            const selector = document.getElementById('user-id-select');
            let options = '';
            
            // Add Instructor IDs
            options += '<optgroup label="INSTRUCTORS">';
            DB.instructors.forEach(i => {
                options += `<option value="I-${i.InstructorID}">I-${i.InstructorID}: ${i.Name}</option>`;
            });
            options += '</optgroup>';

            // Add Admin IDs
            options += '<optgroup label="ADMINS">';
            DB.administrators.forEach(a => {
                options += `<option value="A-${a.AdminID}">A-${a.AdminID}: ${a.Name}</option>`;
            });
            options += '</optgroup>';

            selector.innerHTML = options;
            selector.value = `I-${currentUserId}`; // Set default value
        }

        function updateUserId(value) {
            const [rolePrefix, idString] = value.split('-');
            currentUserId = parseInt(idString);
            currentRole = rolePrefix === 'I' ? 'instructor' : 'admin';
            
            // Load the appropriate view after changing ID
            if (currentRole === 'instructor') {
                loadInstructorView();
            } else {
                loadAdminView();
            }
            updateStatusDisplay();
        }

        function switchRole(role) {
            currentRole = role;
            const selector = document.getElementById('user-id-select');
            const instructorBtn = document.getElementById('btn-instructor');
            const adminBtn = document.getElementById('btn-admin');
            
            // Set currentUserId to the first ID for the target role
            if (role === 'instructor') {
                currentUserId = DB.instructors[0].InstructorID;
                selector.value = `I-${currentUserId}`;
            } else {
                currentUserId = DB.administrators[0].AdminID;
                selector.value = `A-${currentUserId}`;
            }

            // Update button styling
            if (role === 'instructor') {
                loadInstructorView();
                instructorBtn.classList.replace('bg-indigo-600', 'bg-indigo-700');
                instructorBtn.classList.add('shadow-xl');
                adminBtn.classList.replace('bg-amber-700', 'bg-amber-600');
                adminBtn.classList.remove('shadow-xl');
            } else {
                loadAdminView();
                adminBtn.classList.replace('bg-amber-600', 'bg-amber-700');
                adminBtn.classList.add('shadow-xl');
                instructorBtn.classList.replace('bg-indigo-700', 'bg-indigo-600');
                instructorBtn.classList.remove('shadow-xl');
            }
            updateStatusDisplay();
        }

        function updateStatusDisplay() {
            const statusElement = document.getElementById('current-role');
            let name, id;

            if (currentRole === 'instructor') {
                name = DB.instructors.find(i => i.InstructorID === currentUserId)?.Name || 'Unknown Instructor';
                id = currentUserId;
                statusElement.textContent = `Instructor (${name} - ID ${id})`;
                statusElement.style.color = '#10b981';
            } else {
                name = DB.administrators.find(a => a.AdminID === currentUserId)?.Name || 'Unknown Admin';
                id = currentUserId;
                statusElement.textContent = `Administrator (${name} - ID ${id})`;
                statusElement.style.color = '#f59e0b';
            }
            lucide.createIcons();
        }

        // --- 3. Instructor View Functions ---

        function loadInstructorView() {
            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Column 1: Search Panel -->
                    <div class="lg:col-span-1 p-6 bg-gray-50 rounded-xl shadow-lg border border-indigo-100 h-fit">
                        <h2 class="text-xl font-extrabold text-indigo-700 mb-5 flex items-center">
                            <i data-lucide="search" class="icon mr-2 h-5 w-5"></i> Find Resources
                        </h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Minimum Capacity</label>
                                <input type="number" id="search-capacity" value="30" min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Required Technology (Func 2 Logic)</label>
                                <select id="search-feature" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                    <option value="">-- Any Feature --</option>
                                    ${DB.courses.flatMap(c => c.Requirements).filter((v, i, a) => a.indexOf(v) === i).map(f => `<option value="${f}">${f}</option>`).join('')}
                                    <option value="Smartboard">Smartboard</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="search-date" value="2025-12-11" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Start Time</label>
                                <input type="time" id="search-time" value="13:00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <button onclick="searchRooms()" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition duration-200 mt-4">
                                Search Availability
                            </button>
                        </div>
                    </div>
                    
                    <!-- Column 2 & 3: Results and My Bookings Panel -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Search Results -->
                        <div id="room-results-container" class="border p-4 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="building" class="icon mr-2 h-5 w-5"></i> Available Rooms
                            </h2>
                            <div id="results-list" class="scroll-container max-h-[40vh] overflow-y-auto pr-2">
                                <p class="text-gray-500 p-4">Enter criteria and click 'Search' to view results.</p>
                            </div>
                        </div>

                        <!-- My Bookings -->
                        <div id="my-bookings-container" class="border p-4 rounded-xl shadow-md">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="list-checks" class="icon mr-2 h-5 w-5"></i> My Reservations (Informal Query 2 Logic)
                            </h2>
                            <div id="my-bookings-list" class="scroll-container max-h-[30vh] overflow-y-auto pr-2">
                                ${renderMyBookings()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            searchRooms();
        }

        function isRoomAvailable(roomId, date, startTime) {
            // Core logic derived from SQL UNIQUE (RoomID, Date, StartTime) constraint
            return !DB.bookings.some(booking =>
                booking.RoomID === roomId &&
                booking.Status === 'Approved' &&
                booking.Date === date &&
                booking.StartTime === startTime
            );
        }

        function searchRooms() {
            const capacity = parseInt(document.getElementById('search-capacity').value);
            const feature = document.getElementById('search-feature').value;
            const date = document.getElementById('search-date').value;
            const startTime = document.getElementById('search-time').value;

            const results = DB.rooms.filter(room => {
                const capacityMatch = room.Capacity >= capacity;
                const availabilityMatch = isRoomAvailable(room.RoomID, date, startTime);
                const featureMatch = feature ? room.Features.includes(feature) : true;

                // Combined logic from Func 1 & 2
                return capacityMatch && availabilityMatch && featureMatch;
            });

            renderRoomResults(results, date, startTime);
        }

        function renderRoomResults(rooms, date, startTime) {
            const listContainer = document.getElementById('results-list');
            if (rooms.length === 0) {
                listContainer.innerHTML = `<p class="p-4 bg-red-100 text-red-800 rounded-lg flex items-center"><i data-lucide="alert-triangle" class="icon mr-2 h-5 w-5"></i> No available rooms match your criteria.</p>`;
                lucide.createIcons();
                return;
            }

            listContainer.innerHTML = rooms.map(room => `
                <div class="flex justify-between items-center p-4 mb-3 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition duration-150">
                    <div>
                        <p class="text-lg font-bold text-indigo-800">${room.RoomNameOrNumber} <span class="text-xs font-normal text-gray-500">(${room.Location})</span></p>
                        <p class="text-sm text-gray-600 mt-1">Capacity: ${room.Capacity} | Features: ${room.Features.map(f => `<span class="inline-block bg-indigo-100 text-indigo-600 text-xs px-2 py-0.5 rounded-full">${f}</span>`).join(' ')}</p>
                    </div>
                    <button onclick="showBookingForm(${room.RoomID}, '${room.RoomNameOrNumber}', '${date}', '${startTime}')" class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-500 text-white hover:bg-green-600 shadow-md transition duration-150">
                        <i data-lucide="send" class="icon mr-1 h-4 w-4"></i> Request
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function showBookingForm(roomId, roomName, date, startTime) {
            const courseOptions = DB.courses.map(course => `<option value="${course.CourseID}">${course.CourseName}</option>`).join('');
            const icon = `<i data-lucide="calendar-plus" class="icon mr-2 text-indigo-600 h-5 w-5"></i>`;

            showMessage('Request New Booking', `
                <p class="mb-4 text-md text-gray-700 border-b pb-3">Reserving <strong>${roomName}</strong> on <strong>${date}</strong> at <strong>${startTime}</strong>.</p>
                <form id="booking-request-form" onsubmit="submitBookingRequest(event, ${roomId}, '${date}', '${startTime}')">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Course</label>
                            <select id="request-course" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3">
                                ${courseOptions}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">End Time</label>
                            <input type="time" id="request-end-time" value="15:00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="hideMessage()" class="px-5 py-2 text-sm rounded-lg bg-gray-300 hover:bg-gray-400 font-medium">Cancel</button>
                        <button type="submit" class="px-5 py-2 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold shadow-md">Submit Request</button>
                    </div>
                </form>
            `, icon);
        }

        // Core logic derived from SQL INSERT for Bookings table
        function submitBookingRequest(event, roomId, date, startTime) {
            event.preventDefault();
            hideMessage();

            const courseId = parseInt(document.getElementById('request-course').value);
            const endTime = document.getElementById('request-end-time').value;

            if (endTime <= startTime) {
                showMessage('Error', 'End time must be after the start time.', '<i data-lucide="x-circle" class="icon mr-2 text-red-600 h-5 w-5"></i>');
                return;
            }

            if (!isRoomAvailable(roomId, date, startTime)) {
                 showMessage('Error', 'Room was just booked by another user. Please search again.', '<i data-lucide="alert-triangle" class="icon mr-2 text-red-600 h-5 w-5"></i>');
                 searchRooms();
                 return;
            }

            const newBookingId = Math.max(...DB.bookings.map(b => b.BookingID)) + 1;

            const newBooking = {
                BookingID: newBookingId,
                Date: date,
                StartTime: startTime,
                EndTime: endTime,
                Status: 'Pending',
                RoomID: roomId,
                InstructorID: currentUserId,
                CourseID: courseId,
                AdminID: null
            };

            DB.bookings.push(newBooking);
            showMessage('Request Submitted', `Booking request #${newBookingId} for ${DB.rooms.find(r => r.RoomID === roomId).RoomNameOrNumber} is pending approval.`, '<i data-lucide="check-circle" class="icon mr-2 text-green-600 h-5 w-5"></i>');
            
            searchRooms();
            document.getElementById('my-bookings-list').innerHTML = renderMyBookings();
        }

        // Core logic derived from Func 4: Cancel booking
        function cancelBooking(bookingId) {
            if (!confirm(`Confirm cancellation for Booking ID ${bookingId}?`)) return;

            const index = DB.bookings.findIndex(b => b.BookingID === bookingId);
            if (index !== -1 && DB.bookings[index].InstructorID === currentUserId && DB.bookings[index].Status === 'Pending') {
                DB.bookings.splice(index, 1);
                showMessage('Cancelled', `Booking ID ${bookingId} has been successfully cancelled.`, '<i data-lucide="trash-2" class="icon mr-2 text-red-600 h-5 w-5"></i>');
                document.getElementById('my-bookings-list').innerHTML = renderMyBookings();
                searchRooms();
            } else {
                 showMessage('Error', `Cannot cancel Booking ID ${bookingId}. Only pending requests belonging to you can be cancelled.`, '<i data-lucide="x-circle" class="icon mr-2 text-red-600 h-5 w-5"></i>');
            }
        }

        function renderMyBookings() {
            const myBookings = DB.bookings
                .filter(b => b.InstructorID === currentUserId)
                .sort((a, b) => new Date(a.Date) - new Date(b.Date));

            if (myBookings.length === 0) return `<p class="text-gray-500 p-4">You have no reservation history.</p>`;

            const html = `
                <div class="scroll-container max-h-[30vh] overflow-y-auto space-y-3">
                    ${myBookings.map(b => {
                        const roomName = DB.rooms.find(r => r.RoomID === b.RoomID)?.RoomNameOrNumber || 'Unknown Room';
                        const courseName = DB.courses.find(c => c.CourseID === b.CourseID)?.CourseName || 'Unknown Course';
                        let statusClass, iconName;
                        
                        if (b.Status === 'Approved') { statusClass = 'bg-green-100 border-green-300 text-green-800'; iconName = 'check-circle'; }
                        else if (b.Status === 'Pending') { statusClass = 'bg-yellow-100 border-yellow-300 text-yellow-800'; iconName = 'clock'; }
                        else { statusClass = 'bg-red-100 border-red-300 text-red-800'; iconName = 'x-circle'; }

                        return `
                            <div class="flex justify-between items-center p-3 rounded-lg shadow-sm border ${statusClass}">
                                <div class="flex items-center space-x-3">
                                    <i data-lucide="${iconName}" class="icon h-4 w-4"></i>
                                    <div>
                                        <p class="font-bold text-sm">${roomName} (${courseName})</p>
                                        <p class="text-xs text-gray-600">${b.Date} @ ${b.StartTime} - ${b.EndTime}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusClass.replace('border-green-300', '').replace('border-yellow-300', '').replace('border-red-300', '')}">${b.Status.toUpperCase()}</span>
                                    ${b.Status === 'Pending' ? 
                                        `<button onclick="cancelBooking(${b.BookingID})" class="px-3 py-1 text-xs rounded-lg bg-red-500 text-white hover:bg-red-600 shadow-md transition">
                                            <i data-lucide="x" class="icon h-4 w-4"></i> Cancel
                                        </button>` 
                                        : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            return html;
        }


        // --- 4. Administrator View Functions ---

        function loadAdminView() {
            const content = document.getElementById('content-area');
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Column 1 & 2: Pending Requests -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="border p-6 rounded-xl shadow-lg border-amber-300">
                            <h3 class="text-2xl font-extrabold text-amber-700 mb-4 flex items-center">
                                <i data-lucide="clock" class="icon mr-3 h-6 w-6"></i> Awaiting Approval (Informal Query 1 Logic)
                            </h3>
                            <p class="text-sm text-gray-500 mb-4">Review and manage pending room reservation requests.</p>
                            <div id="pending-requests-container" class="scroll-container max-h-[70vh] overflow-y-auto pr-2">
                                ${renderPendingRequests()}
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Room History/Stats Panel -->
                    <div class="lg:col-span-1 p-6 bg-gray-50 rounded-xl shadow-lg border border-gray-200 h-fit">
                        <h3 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="bar-chart" class="icon mr-2 h-5 w-5"></i> Usage History (Informal Query 5 Logic)
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Select a room to view its approved schedule.</p>
                        
                        <select id="history-room-select" onchange="viewRoomHistory(this.value)" class="p-3 border rounded-lg shadow-sm w-full focus:ring-amber-500 focus:border-amber-500 transition">
                            <option value="">-- Select Room --</option>
                            ${DB.rooms.map(r => `<option value="${r.RoomID}">${r.RoomNameOrNumber}</option>`).join('')}
                        </select>
                        
                        <div id="history-results" class="scroll-container max-h-[30vh] overflow-y-auto space-y-3 mt-4 p-2 bg-white rounded-lg border">
                            <p class="text-gray-500 text-sm">Schedule will load here.</p>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function handleAdminAction(bookingId, action) {
            const booking = DB.bookings.find(b => b.BookingID === bookingId);
            if (!booking || booking.Status !== 'Pending') {
                showMessage('Error', `Booking #${bookingId} is not pending.`, '<i data-lucide="x-circle" class="icon mr-2 text-red-600 h-5 w-5"></i>');
                return;
            }
            
            let messageIcon = '';
            let messageTitle = '';
            let isConflict = false;
            
            if (action === 'accept') {
                // Double booking check (critical database UNIQUE constraint logic)
                isConflict = DB.bookings.some(b => 
                    b.RoomID === booking.RoomID &&
                    b.BookingID !== bookingId &&
                    b.Status === 'Approved' &&
                    b.Date === booking.Date &&
                    b.StartTime === booking.StartTime
                );

                if (isConflict) {
                    messageIcon = '<i data-lucide="alert-octagon" class="icon mr-2 text-red-600 h-5 w-5"></i>';
                    messageTitle = 'Conflict Blocked';
                    showMessage(messageTitle, `Cannot approve Booking #${bookingId}. Room ${DB.rooms.find(r => r.RoomID === booking.RoomID).RoomNameOrNumber} is already reserved at that exact time.`, messageIcon);
                    return;
                }
                
                booking.Status = 'Approved';
                booking.AdminID = currentUserId;
                messageIcon = '<i data-lucide="check-circle" class="icon mr-2 text-green-600 h-5 w-5"></i>';
                messageTitle = 'Approved';
                
            } else if (action === 'reject') {
                booking.Status = 'Rejected';
                booking.AdminID = currentUserId;
                messageIcon = '<i data-lucide="x-circle" class="icon mr-2 text-red-600 h-5 w-5"></i>';
                messageTitle = 'Rejected';
            }

            showMessage(messageTitle, `Booking #${bookingId} has been successfully ${messageTitle.toLowerCase()}.`, messageIcon);
            document.getElementById('pending-requests-container').innerHTML = renderPendingRequests();
            viewRoomHistory(document.getElementById('history-room-select').value); // Refresh history if visible
        }

        function renderPendingRequests() {
            const pendingRequests = DB.bookings.filter(b => b.Status === 'Pending');

            if (pendingRequests.length === 0) {
                return `<p class="p-4 bg-green-50 text-green-800 rounded-lg flex items-center"><i data-lucide="thumbs-up" class="icon mr-2 h-5 w-5"></i> All requests are processed.</p>`;
            }

            return pendingRequests.map(b => {
                const room = DB.rooms.find(r => r.RoomID === b.RoomID);
                const instructorName = DB.instructors.find(i => i.InstructorID === b.InstructorID)?.Name || 'Unknown';
                const courseName = DB.courses.find(c => c.CourseID === b.CourseID)?.CourseName || 'Unknown Course';

                return `
                    <div class="flex justify-between items-start p-4 mb-3 rounded-xl shadow-md bg-white border border-gray-200 hover:border-amber-500 transition duration-150">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-gray-900">${room.RoomNameOrNumber} for ${courseName}</p>
                            <p class="text-sm text-gray-600 mt-1">
                                <i data-lucide="user" class="icon h-4 w-4 mr-1 text-amber-500"></i> By: ${instructorName}
                            </p>
                            <p class="text-xs text-gray-500">
                                <i data-lucide="clock" class="icon h-4 w-4 mr-1 text-gray-500"></i> ${b.Date} | ${b.StartTime} - ${b.EndTime}
                            </p>
                            <p class="text-xs text-gray-500 mt-2">Features: ${room.Features.map(f => `<span class="inline-block bg-amber-50 text-amber-600 text-xs px-2 py-0.5 rounded-full">${f}</span>`).join(' ')}</p>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="handleAdminAction(${b.BookingID}, 'accept')" class="px-4 py-2 text-sm font-semibold rounded-lg bg-green-600 text-white hover:bg-green-700 shadow-md transition">
                                <i data-lucide="check" class="icon h-4 w-4"></i> Approve
                            </button>
                            <button onclick="handleAdminAction(${b.BookingID}, 'reject')" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 shadow-md transition">
                                <i data-lucide="x" class="icon h-4 w-4"></i> Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function viewRoomHistory(roomId) {
            const resultsContainer = document.getElementById('history-results');
            if (!roomId) {
                resultsContainer.innerHTML = `<p class="text-gray-500 p-2">Schedule will load here.</p>`;
                return;
            }

            roomId = parseInt(roomId);
            const history = DB.bookings
                .filter(b => b.RoomID === roomId && b.Status === 'Approved')
                .sort((a, b) => new Date(a.Date) - new Date(b.Date));

            if (history.length === 0) {
                 resultsContainer.innerHTML = `<p class="p-2 bg-indigo-50 text-indigo-700 rounded-lg">No approved future or past reservations.</p>`;
                 return;
            }

            resultsContainer.innerHTML = history.map(b => {
                const instructorName = DB.instructors.find(i => i.InstructorID === b.InstructorID)?.Name || 'Unknown';
                const courseName = DB.courses.find(c => c.CourseID === b.CourseID)?.CourseName || 'Unknown';

                return `
                    <div class="p-3 bg-white border border-gray-100 rounded-lg shadow-sm">
                        <p class="font-semibold text-sm text-gray-900">${b.Date} @ ${b.StartTime} - ${b.EndTime}</p>
                        <p class="text-xs text-gray-600">Course: ${courseName} (by ${instructorName})</p>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- 5. Initial Load ---
        window.onload = () => {
            populateUserIdSelector();
            switchRole('instructor');
        };
    </script>
    <script>
        // Initialize Lucide icons after the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
